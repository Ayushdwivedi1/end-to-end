<div class="change-password-container">
  <div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
        <div class="main-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
              <i class="bi bi-shield-check me-2"></i>
              Neural Security - Change Password
            </h4>
            <div class="d-flex gap-2">
              <button class="btn-ai-outline" (click)="goToUsers()">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
          </button>
            </div>
        </div>
        <div class="card-body">
          
          <!-- Error and Success Messages -->
            <div class="alert-ai alert-danger-ai" *ngIf="errorMessage">
              <i class="bi bi-exclamation-triangle me-2"></i>
            {{ errorMessage }}
          </div>
            <div class="alert-ai alert-success-ai" *ngIf="successMessage">
              <i class="bi bi-check-circle me-2"></i>
            {{ successMessage }}
          </div>

          <!-- Step 1: Email Input -->
          <div *ngIf="currentStep === 'email'" class="step-container">
            <form [formGroup]="changePasswordForm" (ngSubmit)="onSendOtp()">
              <div class="form-group">
                  <label for="email" class="form-label">Email Address</label>
                  <div class="input-group-ai">
                <input
                  type="email"
                  id="email"
                  formControlName="email"
                      class="form-control-ai"
                      [readonly]="true"
                    />
                    <div class="input-group-append">
                      <span class="input-group-text-ai">
                        <i class="bi bi-check-circle-fill"></i>
                      </span>
                    </div>
                  </div>
                  <small class="form-text text-muted">
                    <i class="bi bi-info-circle"></i> Using email from your login session: <strong>{{ loggedInUserEmail }}</strong>
                  </small>
              </div>

              <div class="form-actions">
                <button
                  type="submit"
                    class="btn-primary-ai"
                    [disabled]="isLoading"
                >
                    <span class="spinner-border spinner-border-sm spinner-ai me-2" *ngIf="isLoading"></span>
                  {{ isLoading ? 'Sending OTP...' : 'Send OTP' }}
                </button>
                  <button type="button" class="btn-secondary-ai" (click)="goToUsers()">
                  Back to Dashboard
                </button>
              </div>
            </form>
          </div>

          <!-- Step 2: OTP Verification and Password Change -->
          <div *ngIf="currentStep === 'otp'" class="step-container">
            <div class="email-info">
                <p><i class="bi bi-envelope me-2"></i>OTP sent to: <strong>{{ email }}</strong></p>
            </div>

            <form [formGroup]="verifyOtpForm" (ngSubmit)="onVerifyOtp()">
              <div class="form-group">
                  <label for="otp" class="form-label">Enter OTP</label>
                <input
                  type="text"
                  id="otp"
                  formControlName="otp"
                    class="form-control-ai"
                  placeholder="Enter 6-digit OTP"
                  maxlength="6"
                  [class.is-invalid]="verifyOtpForm.get('otp')?.invalid && verifyOtpForm.get('otp')?.touched"
                />
                  <div class="invalid-feedback" *ngIf="verifyOtpForm.get('otp')?.invalid && verifyOtpForm.get('otp')?.touched">
                  <div *ngIf="verifyOtpForm.get('otp')?.errors?.['required']">OTP is required</div>
                  <div *ngIf="verifyOtpForm.get('otp')?.errors?.['minlength'] || verifyOtpForm.get('otp')?.errors?.['maxlength']">OTP must be 6 digits</div>
                </div>
              </div>

              <div class="form-group">
                  <label for="newPassword" class="form-label">New Password</label>
                <input
                  type="password"
                  id="newPassword"
                  formControlName="newPassword"
                    class="form-control-ai"
                  placeholder="Enter new password"
                  [class.is-invalid]="verifyOtpForm.get('newPassword')?.invalid && verifyOtpForm.get('newPassword')?.touched"
                />
                  <div class="invalid-feedback" *ngIf="verifyOtpForm.get('newPassword')?.invalid && verifyOtpForm.get('newPassword')?.touched">
                  <div *ngIf="verifyOtpForm.get('newPassword')?.errors?.['required']">New password is required</div>
                  <div *ngIf="verifyOtpForm.get('newPassword')?.errors?.['minlength']">Password must be at least 6 characters</div>
                </div>
              </div>

              <div class="form-group">
                  <label for="confirmPassword" class="form-label">Confirm New Password</label>
                <input
                  type="password"
                  id="confirmPassword"
                  formControlName="confirmPassword"
                    class="form-control-ai"
                  placeholder="Confirm new password"
                  [class.is-invalid]="verifyOtpForm.get('confirmPassword')?.invalid && verifyOtpForm.get('confirmPassword')?.touched"
                />
                  <div class="invalid-feedback" *ngIf="verifyOtpForm.get('confirmPassword')?.invalid && verifyOtpForm.get('confirmPassword')?.touched">
                  <div *ngIf="verifyOtpForm.get('confirmPassword')?.errors?.['required']">Confirm password is required</div>
                </div>
                  <div class="invalid-feedback" *ngIf="verifyOtpForm.errors?.['passwordMismatch'] && verifyOtpForm.get('confirmPassword')?.touched">
                  Passwords do not match
                </div>
              </div>

              <div class="form-actions">
                <button
                  type="submit"
                    class="btn-primary-ai"
                  [disabled]="verifyOtpForm.invalid || isLoading"
                >
                    <span class="spinner-border spinner-border-sm spinner-ai me-2" *ngIf="isLoading"></span>
                  {{ isLoading ? 'Changing Password...' : 'Change Password' }}
                </button>
                  <button type="button" class="btn-secondary-ai" (click)="goBack()">
                  Back
                </button>
                  <button type="button" class="btn-ai-outline" (click)="resendOtp()" [disabled]="isLoading">
                  Resend OTP
                </button>
              </div>
            </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div> 